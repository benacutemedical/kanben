
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Zen Kanban To-Do (Cloud)</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#fafafa}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #ddd}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;display:flex;justify-content:space-between;align-items:center}
    .btn{cursor:pointer;border:1px solid #ccc;background:#fff;padding:6px 12px;border-radius:6px}
    .btn.primary{background:#000;color:#fff}
    .boards{max-width:1100px;margin:24px auto;display:flex;flex-direction:column;gap:16px}
    .board{border:1px solid #ddd;border-radius:12px;background:#fff}
    .board-head{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #ddd;cursor:grab}
    .columns{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:12px}
    .column{border:1px dashed #ccc;border-radius:8px;min-height:120px;padding:6px;display:flex;flex-direction:column;gap:6px}
    .column.drag-over{background:#f0f8ff;border-color:#0077ff}
    .task{border:1px solid #ddd;border-radius:8px;padding:8px;background:#fff;cursor:grab;position:relative}
    .task h3{margin:0 0 4px;font-size:14px}
    .delete-btn{position:absolute;top:2px;right:2px;cursor:pointer;border:none;background:none;color:#900}
    .compact .t-details,.compact .t-links,.compact .t-attachments,.compact .checklist{display:none}
    .t-links a{display:block;font-size:12px;color:#0077cc;word-break:break-all}
    .t-attachments img{max-width:90px;max-height:70px;border-radius:4px;border:1px solid #ccc}
    .t-attachments a{display:inline-block;font-size:12px}
    .checklist label{display:flex;align-items:center;font-size:12px;gap:6px}
    .checklist label.done{color:#888;text-decoration:line-through;opacity:0.7}
    .timer{font-size:12px;display:block;margin-top:4px}
    .assignee-badge{display:flex;align-items:center;gap:6px;margin-top:6px}
    .avatar{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;font-weight:bold;background:#555;overflow:hidden;background-size:cover;background-position:center}
    dialog{border:none;padding:0;border-radius:12px;box-shadow:0 20px 80px rgba(0,0,0,.18);}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    #taskDialog{width:min(900px,96vw);max-height:90vh;overflow:auto}
    #taskDialog form{display:flex;flex-direction:column;gap:12px;padding:20px}
    #taskDialog input,#taskDialog textarea{width:100%;box-sizing:border-box}
    #taskDialog textarea{min-height:120px}
    #linksContainer,#checklistContainer{padding:10px;border:1px solid #ccc;border-radius:6px}
    .link-input,.check-input{display:flex;gap:6px;margin-top:6px}
    .link-input input,.check-input input{flex:1}
    #taskDialog .actions{display:flex;justify-content:flex-end;gap:10px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div>Zen Kanban (Cloud)</div>
    <button id="addTaskBtn" class="btn primary">‚ûï Add Task</button>
  </div>
</header>

<main class="boards" id="boards"></main>

<dialog id="taskDialog">
  <form>
    <input type="hidden" id="editId">
    <label>Title</label><input id="title" required>
    <label>Project</label><input id="project" required>
    <label>Assignee</label><input id="assignee" placeholder="Optional">
    <label>Assignee Colour</label><input type="color" id="assigneeColor" value="#555555">
    <label>Avatar URL</label><input id="avatarUrl" placeholder="https://...">
    <label>Avatar Upload</label><input type="file" id="avatarFile" accept="image/*">
    <label>Details</label><textarea id="details"></textarea>
    <label>Attachments</label><input type="file" id="attachments" multiple>
    <div id="linksContainer">
      <label>Links</label>
      <button type="button" id="addLinkBtn" class="btn">Add Link</button>
    </div>
    <div id="checklistContainer">
      <label>Tasks</label>
      <button type="button" id="addCheckBtn" class="btn">Add Item</button>
    </div>
    <div class="actions">
      <button type="button" id="cancelCreate" class="btn">Cancel</button>
      <button type="submit" class="btn primary">Save</button>
    </div>
  </form>
</dialog>

<template id="boardTemplate">
  <section class="board" draggable="true">
    <div class="board-head">
      <div style="display:flex;align-items:center;gap:10px">
        <span class="index-badge"></span>
        <h2 class="project-name" style="margin:0;font-size:18px"></h2>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button class="toggle-view btn">üóñ Expanded</button>
        <input type="color" class="boardColorPicker">
        <button class="delete-board btn">‚ùå</button>
      </div>
    </div>
    <div class="columns"></div>
  </section>
</template>

<template id="columnTemplate">
  <div class="column"><div class="col-name" style="font-weight:bold;margin-bottom:4px"></div></div>
</template>

<template id="taskTemplate">
  <article class="task" draggable="true">
    <button class="delete-btn">‚úñ</button>
    <h3 class="t-title"></h3>
    <div class="t-details"></div>
    <div class="t-links"></div>
    <div class="t-attachments"></div>
    <div class="checklist"></div>
    <span class="timer"></span>
    <div class="assignee-badge"></div>
  </article>
</template>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // üî• Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCdvzN-WZ-YNKfYCpuNk6nAWzriFbPHLjg",
    authDomain: "kanben-acutesoft.firebaseapp.com",
    projectId: "kanben-acutesoft",
    storageBucket: "kanben-acutesoft.firebasestorage.app",
    messagingSenderId: "637159945341",
    appId: "1:637159945341:web:1c5dbd01eeff6422fd6d14",
    measurementId: "G-GND9Q3PN18"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const docRef = doc(db, "kanban", "shared");

  // ===== State =====
  const state={projects:{},order:[]};
  const uid=()=>Math.random().toString(36).slice(2,9);
  const save=()=>setDoc(docRef,JSON.parse(JSON.stringify(state)));

  // ===== Sync from Firestore =====
  onSnapshot(docRef,snap=>{
    if(snap.exists()){
      Object.assign(state,snap.data());
      render();
    } else {
      // bootstrap empty project
      const sample={name:'Sample Project',columns:[{id:uid(),name:'To Do'},{id:uid(),name:'In Progress'},{id:uid(),name:'Completed'}],tasks:{},color:'#eee'};
      const tid=uid();
      sample.tasks[tid]={id:tid,title:'Example Task',details:'Try editing me',assignee:'You',assigneeColor:'#555',links:['https://example.com'],attachments:[],checklist:[{text:'Sample step',done:false}],createdAt:Date.now()};
      state.projects[sample.name]=sample; state.order.push(sample.name);
      save();
    }
  });

  // ===== Rendering =====
  const boards=document.getElementById('boards');
  const render=()=>{
    boards.innerHTML='';
    state.order.forEach((n,i)=>{
      const p=state.projects[n];
      if(p) boards.appendChild(renderBoard(p,i));
    });
  };

  const renderBoard=(p,idx)=>{
    const frag=document.getElementById('boardTemplate').content.cloneNode(true);
    const b=frag.querySelector('.board');
    b.dataset.project=p.name;
    frag.querySelector('.index-badge').textContent=idx+1;
    const titleEl=frag.querySelector('.project-name');
    titleEl.textContent=p.name;
    // color header
    const head=frag.querySelector('.board-head');
    head.style.background=p.color||'#ddd';
    const colorPicker=frag.querySelector('.boardColorPicker');
    colorPicker.value=p.color||'#ddd';
    colorPicker.addEventListener('input',()=>{
      p.color=colorPicker.value;
      save();
    });
    // delete board
    frag.querySelector('.delete-board').addEventListener('click',()=>{
      const pwd=prompt("Enter GODMODE! password to erase this board");
      if(pwd==="GODMODE!"){
        delete state.projects[p.name];
        state.order=state.order.filter(x=>x!==p.name);
        save();
      }
    });
    // compact/expand
    const toggleBtn=frag.querySelector('.toggle-view');
    toggleBtn.addEventListener('click',()=>{
      b.classList.toggle('compact');
    });

    // columns
    const cols=frag.querySelector('.columns');
    p.columns.forEach(c=>{
      const col=document.getElementById('columnTemplate').content.cloneNode(true);
      col.querySelector('.col-name').textContent=c.name;
      const colEl=col.querySelector('.column');
      colEl.dataset.colid=c.id;
      colEl.dataset.project=p.name;
      // drag target
      colEl.addEventListener('dragover',e=>{
        e.preventDefault(); colEl.classList.add('drag-over');
      });
      colEl.addEventListener('dragleave',()=>colEl.classList.remove('drag-over'));
      colEl.addEventListener('drop',e=>{
        e.preventDefault();
        colEl.classList.remove('drag-over');
        const tid=e.dataTransfer.getData('text/plain');
        const task=Object.values(p.tasks).find(t=>t.id===tid);
        if(!task) return;
        // GODMODE check if Completed col
        if(c.name==="Completed"){
          const pwd=prompt("Enter GODMODE! password to move task to Completed");
          if(pwd!=="GODMODE!") return;
        }
        task.colId=c.id;
        save();
      });
      // append tasks
      Object.values(p.tasks).forEach(t=>{
        const colMatch=t.colId||p.columns[0].id;
        if(colMatch===c.id) colEl.appendChild(renderTask(p,t));
      });
      cols.appendChild(col);
    });
    return frag;
  };

  const renderTask=(p,t)=>{
    const frag=document.getElementById('taskTemplate').content.cloneNode(true);
    const card=frag.querySelector('.task');
    card.dataset.id=t.id;
    frag.querySelector('.t-title').textContent=t.title;
    frag.querySelector('.t-details').textContent=t.details||'';
    // links
    const ldiv=frag.querySelector('.t-links');
    (t.links||[]).forEach(l=>{
      const a=document.createElement('a');
      a.href=l.startsWith('http')?l:'https://'+l;
      a.textContent=l; a.target="_blank";
      ldiv.appendChild(a);
    });
    // attachments
    const adiv=frag.querySelector('.t-attachments');
    (t.attachments||[]).forEach(att=>{
      if(att.type&&att.type.startsWith('image/')){
        const img=document.createElement('img');
        img.src=att.url; adiv.appendChild(img);
      } else {
        const a=document.createElement('a');
        a.href=att.url; a.textContent=att.name||'file'; a.target="_blank";
        adiv.appendChild(a);
      }
    });
    // checklist
    const cdiv=frag.querySelector('.checklist');
    (t.checklist||[]).forEach(item=>{
      const lbl=document.createElement('label');
      if(item.done) lbl.classList.add('done');
      const cb=document.createElement('input');
      cb.type='checkbox'; cb.checked=!!item.done;
      cb.addEventListener('change',()=>{
        item.done=cb.checked;
        if(cb.checked) lbl.classList.add('done'); else lbl.classList.remove('done');
        save();
      });
      lbl.appendChild(cb); lbl.append(item.text);
      cdiv.appendChild(lbl);
    });
    // timer
    const timerEl=frag.querySelector('.timer');
    const updateTimer=()=>{
      if(!t.createdAt) return;
      const diff=Date.now()-t.createdAt;
      const days=Math.floor(diff/(1000*60*60*24));
      const hours=Math.floor((diff/(1000*60*60))%24);
      timerEl.textContent=`${days}d ${hours}h`;
      if(diff>86400000){ // >24h
        timerEl.style.color=`rgb(${Math.min(255,100+days*30)},0,0)`;
      }
    };
    setInterval(updateTimer,60000);
    updateTimer();
    // assignee
    const ab=frag.querySelector('.assignee-badge');
    if(t.assignee){
      const av=document.createElement('div');
      av.className='avatar';
      if(t.avatarUrl) av.style.backgroundImage=`url(${t.avatarUrl})`;
      else av.textContent=t.assignee[0].toUpperCase();
      av.style.backgroundColor=t.assigneeColor||'#555';
      const span=document.createElement('span');
      span.textContent=t.assignee;
      ab.appendChild(av); ab.appendChild(span);
    }
    // delete
    frag.querySelector('.delete-btn').addEventListener('click',e=>{
      e.stopPropagation();
      if(confirm("Delete this task?")){
        delete p.tasks[t.id]; save();
      }
    });
    // edit
    card.addEventListener('click',e=>{
      if(e.target.classList.contains('delete-btn')) return;
      openEditDialog(p,t);
    });
    // drag
    card.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain',t.id);
    });
    return frag;
  };
  // ===== Modal Logic =====
  const dialog=document.getElementById('taskDialog');
  const form=dialog.querySelector('form');
  document.getElementById('addTaskBtn').addEventListener('click',()=>openEditDialog());
  document.getElementById('cancelCreate').addEventListener('click',()=>dialog.close());

  dialog.addEventListener('click',e=>{
    if(e.target && e.target.id==='addLinkBtn'){
      e.preventDefault(); addLinkInput('');
    } else if(e.target && e.target.id==='addCheckBtn'){
      e.preventDefault(); addCheckInput('');
    }
  });

  const addLinkInput=(value)=>{ 
    const container=document.getElementById('linksContainer');
    const div=document.createElement('div'); div.className='link-input';
    const input=document.createElement('input'); input.type='text'; input.placeholder='example.com'; input.value=value||'';
    const btn=document.createElement('button'); btn.type='button'; btn.textContent='‚úñ';
    btn.addEventListener('click',()=>div.remove());
    div.append(input,btn); container.appendChild(div);
  };
  const addCheckInput=(value)=>{ 
    const container=document.getElementById('checklistContainer');
    const div=document.createElement('div'); div.className='check-input';
    const input=document.createElement('input'); input.type='text'; input.placeholder='Task item'; input.value=value||'';
    const btn=document.createElement('button'); btn.type='button'; btn.textContent='‚úñ';
    btn.addEventListener('click',()=>div.remove());
    div.append(input,btn); container.appendChild(div);
  };

  const openEditDialog=(project,t)=>{
    form.reset();
    document.getElementById('linksContainer').innerHTML='<label>Links</label> <button type="button" id="addLinkBtn" class="btn">Add Link</button>';
    document.getElementById('checklistContainer').innerHTML='<label>Tasks</label> <button type="button" id="addCheckBtn" class="btn">Add Item</button>';
    document.getElementById('attachments').value=null;
    if(t){
      document.getElementById('editId').value=t.id;
      document.getElementById('title').value=t.title;
      document.getElementById('project').value=project.name;
      document.getElementById('assignee').value=t.assignee||'';
      document.getElementById('assigneeColor').value=t.assigneeColor||'#555555';
      document.getElementById('avatarUrl').value=t.avatarUrl||'';
      (t.links||[]).forEach(l=>addLinkInput(l));
      (t.checklist||[]).forEach(item=>addCheckInput(item.text));
      document.getElementById('details').value=t.details||'';
    } else {
      document.getElementById('editId').value='';
    }
    dialog.showModal();
  };

  // ===== Form Submit =====
  form.addEventListener('submit',e=>{
    e.preventDefault();
    const id=document.getElementById('editId').value;
    const title=document.getElementById('title').value.trim();
    const projectName=document.getElementById('project').value.trim();
    if(!title||!projectName) return;

    const assignee=document.getElementById('assignee').value.trim();
    const assigneeColor=document.getElementById('assigneeColor').value;
    const avatarUrl=document.getElementById('avatarUrl').value.trim();
    const links=[...document.querySelectorAll('#linksContainer input[type="text"]')].map(i=>i.value.trim()).filter(Boolean);
    const details=document.getElementById('details').value.trim();
    const checklist=[...document.querySelectorAll('#checklistContainer .check-input input')].map(i=>({text:i.value.trim(),done:false})).filter(i=>i.text);
    const files=[...document.getElementById('attachments').files].map(f=>({name:f.name,type:f.type,url:URL.createObjectURL(f)}));

    let proj=state.projects[projectName];
    if(!proj){
      proj={name:projectName,columns:[{id:uid(),name:'To Do'},{id:uid(),name:'In Progress'},{id:uid(),name:'Completed'}],tasks:{},color:'#eee'};
      state.projects[projectName]=proj; state.order.push(projectName);
    }

    if(id && proj.tasks[id]){
      Object.assign(proj.tasks[id],{title,details,assignee,assigneeColor,avatarUrl,links,attachments:files,checklist});
    } else {
      const newId=uid();
      proj.tasks[newId]={id:newId,title,details,assignee,assigneeColor,avatarUrl,links,attachments:files,checklist,createdAt:Date.now()};
    }
    save();
    dialog.close();
  });
</script>
</body>
</html>
<!-- === END PART 3 === -->