<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zen Kanban To-Do</title>
  <style>
    :root{ --bg:#fff; --card:#fff; --ink:#000; --muted:#555; --line:#e0e0e0; --radius:16px; --shadow:0 2px 10px rgba(0,0,0,.05);}
    *{box-sizing:border-box}
    body{margin:0;font-family:sans-serif;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .toolbar{display:flex;align-items:center;justify-content:space-between}
    .btn{cursor:pointer;border:1px solid var(--line);background:#fff;padding:6px 12px;border-radius:8px}
    .btn.primary{background:#000;color:#fff}
    .boards{max-width:1100px;margin:24px auto;display:flex;flex-direction:column;gap:16px}
    .board{border:1px solid var(--line);border-radius:16px;background:var(--card)}
    .board-head{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--line)}
    .index-badge{border:1px solid var(--line);border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:12px}
    .columns{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:12px}
    .column{border:1px dashed var(--line);border-radius:10px;min-height:120px;padding:6px;display:flex;flex-direction:column;gap:6px}
    .task{border:1px solid var(--line);border-radius:10px;padding:6px;background:#fff;cursor:grab;position:relative}
    .task h3{margin:0;font-size:14px}
    .delete-btn{position:absolute;top:2px;right:2px;cursor:pointer;border:none;background:none;color:#900}
    .t-links a{display:block;font-size:12px;word-break:break-all}
    .t-attachments img{max-height:60px;margin-top:4px}
    .t-attachments a{display:block;font-size:12px;margin-top:4px}
    .checklist label{display:flex;align-items:center;font-size:12px;gap:6px;margin:2px 0}
    .checklist label.done{color:var(--muted);text-decoration:line-through}
    .collapsed .columns{display:none}
    .link-input,.check-input{display:flex;gap:6px;margin:6px 0}
    .link-input input,.check-input input{flex:1}
    dialog{border:none;padding:0;border-radius:16px;box-shadow:0 20px 80px rgba(0,0,0,.18);}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    #taskDialog{width:min(1100px,96vw);max-height:90vh;overflow:auto}
    #taskDialog form{display:flex;flex-direction:column;gap:18px;padding:24px}
    #taskDialog label{display:block;margin:6px 0 4px;font-weight:bold}
    #taskDialog textarea{min-height:100px;width:100%}
    #linksContainer,#attachmentsContainer,#checklistContainer{margin-top:8px;padding:12px;border:1px solid var(--line);border-radius:8px}
    #taskDialog .actions{display:flex;justify-content:flex-end;gap:10px}
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}
    #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:6px;opacity:0;transition:opacity .3s}
    #toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <div class="wrap toolbar">
      <div>Zen Kanban To-Do</div>
      <div style="display:flex;gap:8px">
        <button id="driveSignIn" class="btn">ðŸ”‘ Drive</button>
        <button id="backupNow" class="btn" disabled>ðŸ’¾ Backup</button>
        <button id="restoreBackup" class="btn" disabled>â™» Restore</button>
        <button id="addTaskBtn" class="btn primary">âž• Add Task</button>
      </div>
    </div>
  </header>

  <main class="boards" id="boards"></main>
  <div id="toast"></div>

  <dialog id="taskDialog">
    <form class="card">
      <input type="hidden" id="editId">
      <div>
        <label>Title</label>
        <input id="title" required>
        <label>Project</label>
        <input id="project" required>
        <label>Assignee</label>
        <input id="assignee">
        <hr>
        <div id="linksContainer">
          <label>Links</label>
          <button type="button" id="addLinkBtn">Add Link</button>
        </div>
        <hr>
        <div id="attachmentsContainer">
          <label>Attachments</label>
          <input id="attachments" type="file" multiple>
        </div>
        <hr>
        <label>Details</label>
        <textarea id="details"></textarea>
        <hr>
        <div id="checklistContainer">
          <label>Tasks</label>
          <button type="button" id="addCheckBtn">Add Item</button>
        </div>
      </div>
      <div class="actions">
        <button type="button" id="cancelCreate" class="btn">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </dialog>

  <template id="boardTemplate">
    <section class="board">
      <div class="board-head">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="index-badge"></span>
          <h2 class="project-name" style="margin:0"></h2>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <input type="color" class="boardColorPicker">
          <button class="collapse-toggle btn">â–¾</button>
          <button class="move-up btn">â¬†</button>
          <button class="move-down btn">â¬‡</button>
          <button class="add-column btn">âž• Column</button>
          <button class="delete-board btn">ðŸ—‘</button>
        </div>
      </div>
      <div class="columns"></div>
    </section>
  </template>

  <template id="columnTemplate">
    <div class="column"><div class="col-name"></div></div>
  </template>

  <template id="taskTemplate">
    <article class="task" draggable="true">
      <button class="delete-btn">âœ–</button>
      <h3 class="t-title"></h3>
      <div class="t-details"></div>
      <div class="t-links"></div>
      <div class="t-attachments"></div>
      <div class="checklist"></div>
      <span class="timer"></span>
      <div class="assignee-badge"></div>
    </article>
  </template>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyCdvzN-WZ-YNKfYCpuNk6nAWzriFbPHLjg",
      authDomain: "kanben-acutesoft.firebaseapp.com",
      projectId: "kanben-acutesoft",
      storageBucket: "kanben-acutesoft.appspot.com",
      messagingSenderId: "637159945341",
      appId: "1:637159945341:web:1c5dbd01eeff6422fd6d14",
      measurementId: "G-GND9Q3PN18"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const kanbanRef = doc(db,"kanban","prod");

    const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');clearTimeout(t._h);t._h=setTimeout(()=>t.classList.remove('show'),2000);};

    let state={projects:{},order:[]};
    const uid=()=>Math.random().toString(36).slice(2,9);

    async function save(){await setDoc(kanbanRef,state);}
    onSnapshot(kanbanRef,(snap)=>{if(snap.exists()){state=snap.data();render();}});

    const boards=document.getElementById('boards');

    function render(){
      boards.innerHTML='';
      state.order.forEach((n,i)=>{const p=state.projects[n];if(p)boards.appendChild(renderBoard(p,i));});
      save();
    }

    function renderBoard(p,idx){
      const frag=document.getElementById('boardTemplate').content.cloneNode(true);
      const b=frag.querySelector('.board');b.dataset.project=p.name;
      frag.querySelector('.index-badge').textContent=idx+1;
      frag.querySelector('.project-name').textContent=p.name;
      const cols=frag.querySelector('.columns');
      if(p.collapsed)cols.style.display="none";
      frag.querySelector('.collapse-toggle').onclick=()=>{p.collapsed=!p.collapsed;render();};
      frag.querySelector('.move-up').onclick=()=>{if(idx>0)[state.order[idx-1],state.order[idx]]=[state.order[idx],state.order[idx-1]];render();};
      frag.querySelector('.move-down').onclick=()=>{if(idx<state.order.length-1)[state.order[idx+1],state.order[idx]]=[state.order[idx],state.order[idx+1]];render();};
      frag.querySelector('.boardColorPicker').value=p.color||"#eee";
      frag.querySelector('.boardColorPicker').oninput=(e)=>{p.color=e.target.value;b.querySelector('.board-head').style.background=p.color;save();};
      frag.querySelector('.delete-board').onclick=()=>{if(prompt("Enter GODMODE! password")==="GODMODE!"){delete state.projects[p.name];state.order=state.order.filter(x=>x!==p.name);render();}};
      p.columns.forEach(c=>{
        const col=document.getElementById('columnTemplate').content.cloneNode(true);
        col.querySelector('.col-name').textContent=c.name;
        const colEl=col.querySelector('.column');colEl.dataset.colId=c.id;
        colEl.ondragover=(e)=>{e.preventDefault();};
        colEl.ondrop=(e)=>{e.preventDefault();const tid=e.dataTransfer.getData("text");const t=Object.values(p.tasks).find(x=>x.id===tid);if(t){t.colId=c.id;save();render();}};
        Object.values(p.tasks).filter(t=>t.colId===c.id).forEach(t=>colEl.appendChild(renderTask(p,t)));
        cols.appendChild(col);
      });
      frag.querySelector('.add-column').onclick=()=>{const name=prompt("Column name?");if(name){p.columns.push({id:uid(),name});save();render();}};
      return frag;
    }

    function renderTask(p,t){
      const frag=document.getElementById('taskTemplate').content.cloneNode(true);
      const card=frag.querySelector('.task');card.dataset.id=t.id;
      frag.querySelector('.t-title').textContent=t.title;
      frag.querySelector('.t-details').textContent=t.details||'';
      const linksDiv=frag.querySelector('.t-links');(t.links||[]).forEach(l=>{const a=document.createElement('a');a.href=l;a.textContent=l;linksDiv.appendChild(a);});
      const attDiv=frag.querySelector('.t-attachments');(t.attachments||[]).forEach(att=>{if(att.type&&att.type.startsWith("image/")){const img=document.createElement('img');img.src=att.url;attDiv.appendChild(img);}else{const a=document.createElement('a');a.href=att.url;a.textContent=att.name;attDiv.appendChild(a);}});
      const cl=frag.querySelector('.checklist');(t.checklist||[]).forEach(item=>{const lbl=document.createElement('label');if(item.done)lbl.classList.add('done');const cb=document.createElement('input');cb.type='checkbox';cb.checked=!!item.done;cb.onchange=()=>{item.done=cb.checked;save();};lbl.append(cb,document.createTextNode(item.text));cl.appendChild(lbl);});
      frag.querySelector('.delete-btn').onclick=()=>{if(confirm("Delete?")){delete p.tasks[t.id];save();render();}};
      card.ondragstart=(e)=>{e.dataTransfer.setData("text",t.id);};
      card.onclick=(e)=>{if(e.target.classList.contains("delete-btn"))return;openEditDialog(p,t);};
      return frag;
    }

    // Dialog
    const dialog=document.getElementById('taskDialog');const form=dialog.querySelector('form');
    document.getElementById('addTaskBtn').onclick=()=>openEditDialog();
    document.getElementById('cancelCreate').onclick=()=>dialog.close();

    dialog.addEventListener('click',(e)=>{
      if(e.target.id==='addLinkBtn'){addLinkInput('');}
      else if(e.target.id==='addCheckBtn'){addCheckInput('');}
    });
    function addLinkInput(v){const c=document.getElementById('linksContainer');const d=document.createElement('div');d.className="link-input";const i=document.createElement('input');i.type="text";i.placeholder="Link";i.value=v||"";const b=document.createElement('button');b.type="button";b.textContent="âœ–";b.onclick=()=>d.remove();d.append(i,b);c.appendChild(d);}
    function addCheckInput(v){const c=document.getElementById('checklistContainer');const d=document.createElement('div');d.className="check-input";const i=document.createElement('input');i.type="text";i.placeholder="Task";i.value=v||"";const b=document.createElement('button');b.type="button";b.textContent="âœ–";b.onclick=()=>d.remove();d.append(i,b);c.appendChild(d);}

    function openEditDialog(project,t){
      form.reset();
      document.getElementById('linksContainer').innerHTML='<label>Links</label><button type="button" id="addLinkBtn">Add Link</button>';
      document.getElementById('checklistContainer').innerHTML='<label>Tasks</label><button type="button" id="addCheckBtn">Add Item</button>';
      document.getElementById('attachments').value=null;
      if(t){
        document.getElementById('editId').value=t.id;
        document.getElementById('title').value=t.title;
        document.getElementById('project').value=project.name;
        document.getElementById('assignee').value=t.assignee||'';
        (t.links||[]).forEach(l=>addLinkInput(l));
        (t.checklist||[]).forEach(i=>addCheckInput(i.text));
        document.getElementById('details').value=t.details||'';
      } else {document.getElementById('editId').value='';}
      dialog.showModal();
    }

    form.onsubmit=async(e)=>{
      e.preventDefault();
      const id=document.getElementById('editId').value;
      const title=document.getElementById('title').value.trim();
      const project=document.getElementById('project').value.trim();
      if(!title||!project)return;
      const assignee=document.getElementById('assignee').value.trim();
      const links=[...document.querySelectorAll('#linksContainer input[type="text"]')].map(i=>i.value).filter(Boolean);
      const details=document.getElementById('details').value.trim();
      const checklist=[...document.querySelectorAll('#checklistContainer .check-input input')].map(i=>({text:i.value,done:false})).filter(i=>i.text);
      const proj=state.projects[project]||(state.projects[project]={name:project,columns:[{id:uid(),name:'To Do'},{id:uid(),name:'In Progress'},{id:uid(),name:'Completed'}],tasks:{},color:"#eee",collapsed:false});
      if(!state.order.includes(project))state.order.push(project);

      let attachments=[];
      const files=[...document.getElementById('attachments').files];
      for(const f of files){
        const storageRef=ref(storage,`attachments/${project}/${id||uid()}-${f.name}`);
        await uploadBytes(storageRef,f);
        const url=await getDownloadURL(storageRef);
        attachments.push({name:f.name,type:f.type,url});
      }

      if(id && proj.tasks[id]){
        Object.assign(proj.tasks[id],{title,details,assignee,links,attachments,checklist});
      } else {
        const newId=uid();
        proj.tasks[newId]={id:newId,title,details,assignee,links,attachments,checklist,colId:proj.columns[0].id,created:Date.now()};
      }
      await save();dialog.close();render();
    };

    // Bootstrap
    (async
         // Bootstrap
    (async()=>{
      const snap = await getDoc(kanbanRef);
      if(!snap.exists()){
        const sample = {
          name: "Sample",
          columns: [
            {id: uid(), name: "To Do"},
            {id: uid(), name: "In Progress"},
            {id: uid(), name: "Completed"}
          ],
          tasks: {},
          color: "#eee",
          collapsed: false
        };
        const tid = uid();
        sample.tasks[tid] = {
          id: tid,
          title: "First Task",
          details: "Edit me",
          assignee: "You",
          links: [],
          attachments: [],
          checklist: [],
          colId: sample.columns[0].id,
          created: Date.now()
        };
        state.projects[sample.name] = sample;
        state.order = [sample.name];
        await save();
      } else {
        state = snap.data();
      }
      render();
    })();

  </script>
</body>
</html>
