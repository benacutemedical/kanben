<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Zen Kanban</title>
  <style>
    :root { --radius:12px }
    * { box-sizing:border-box }
    body { margin:0; font-family:sans-serif; background:#fafafa; color:#111 }
    header { position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #ddd; text-align:center; }
    .wrap { max-width:1100px; margin:0 auto; padding:12px; display:flex; justify-content:space-between; align-items:center; gap:10px }
    .left, .right { display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .btn { cursor:pointer; border:1px solid #ccc; background:#fff; padding:6px 10px; border-radius:8px }
    .btn.primary { background:#000; color:#fff; border-color:#000 }
    .btn:disabled { opacity:.5; cursor:not-allowed }
    .boards { max-width:1100px; margin:20px auto; display:flex; flex-direction:column; gap:16px }
    .board { border:1px solid #ddd; border-radius:var(--radius); background:#fff }
    .board-head { display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #ddd }
    .columns { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:12px; padding:12px }
    .column { border:1px dashed #ccc; border-radius:10px; min-height:140px; padding:6px; display:flex; flex-direction:column; gap:6px }
    .column.drag-over { background:#eef6ff; border-color:#2b78ff }
    .task { border:1px solid #ddd; border-radius:10px; padding:8px; background:#fff; cursor:grab; position:relative }
    .task h3 { margin:0 0 4px; font-size:14px }
    .delete-btn { position:absolute; top:2px; right:2px; border:none; background:none; color:#a00; font-size:16px; cursor:pointer }
    .t-links a { display:block; font-size:12px; word-break:break-all; color:#0b67c2 }
    .t-attachments img { max-width:100px; max-height:80px; border:1px solid #ddd; border-radius:6px }
    .t-attachments a { display:inline-block; font-size:12px }
    .checklist label { display:flex; align-items:center; gap:6px; font-size:12px }
    .checklist label.done { color:#777; text-decoration:line-through }
    .timer { font-size:12px; display:block; margin-top:4px }
    .assignee-badge { display:flex; align-items:center; gap:6px; margin-top:6px }
    .avatar { width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; color:#fff; font-weight:bold; background:#555; overflow:hidden; background-size:cover; background-position:center }
    .board.collapsed .columns { display:none }
    dialog { border:none; padding:0; border-radius:16px; box-shadow:0 20px 80px rgba(0,0,0,.18); }
    dialog::backdrop { background:rgba(0,0,0,.35) }
    #taskDialog { width:min(1000px,96vw); max-height:90vh; overflow:auto }
    #taskDialog form { display:flex; flex-direction:column; gap:12px; padding:20px }
    #taskDialog input, #taskDialog textarea { width:100% }
    #taskDialog textarea { min-height:160px }
    #linksContainer, #checklistContainer { padding:10px; border:1px solid #ccc; border-radius:8px }
    .link-input, .check-input { display:flex; gap:6px; margin-top:6px }
    .link-input input, .check-input input { flex:1 }
    #taskDialog .actions { display:flex; justify-content:flex-end; gap:10px }
    #toast { position:fixed; left:50%; transform:translateX(-50%); bottom:14px; background:#111; color:#fff; padding:8px 12px; border-radius:8px; font-size:12px; opacity:0; transition:opacity .2s }
    #toast.show { opacity:1 }
    #logoPreview { max-height:60px; object-fit:contain }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="left">
        <img id="logoPreview" src="" alt="Logo">
        <button id="uploadLogoBtn" class="btn">üñº Upload Logo</button>
        <input type="file" id="logoUpload" accept="image/*" hidden>
        <button id="addTaskBtn" class="btn primary">‚ûï Add Task</button>
      </div>
      <div class="right">
        <button id="driveSignIn" class="btn">üîë Sign in to Drive</button>
        <button id="backupNow" class="btn" disabled>üíæ Backup Now</button>
        <button id="restoreBackup" class="btn" disabled>‚ôª Restore Backup</button>
        <label class="switch"><input type="checkbox" id="autoBackup" disabled> Auto-backup</label>
      </div>
    </div>
  </header>

  <main class="boards" id="boards"></main>
  <div id="toast"></div>

  <!-- Task Dialog -->
  <dialog id="taskDialog">
    <form>
      <input type="hidden" id="editId">
      <input type="hidden" id="editProject">
      <label>Title</label><input id="title" required>
      <label>Project</label><input id="project" required>
      <label>Assignee</label><input id="assignee" placeholder="Optional">
      <label>Assignee Colour</label><input type="color" id="assigneeColor" value="#555555">
      <label>Avatar URL</label><input id="avatarUrl" placeholder="https://...">
      <label>Avatar Upload</label><input type="file" id="avatarFile" accept="image/*">
      <label>Details</label><textarea id="details"></textarea>
      <label>Attachments</label><input type="file" id="attachments" multiple>
      <div id="linksContainer">
        <label>Links</label>
        <button type="button" id="addLinkBtn" class="btn">Add Link</button>
      </div>
      <div id="checklistContainer">
        <label>Tasks</label>
        <button type="button" id="addCheckBtn" class="btn">Add Item</button>
      </div>
      <div class="actions">
        <button type="button" id="cancelCreate" class="btn">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Templates -->
  <template id="boardTemplate">
    <section class="board">
      <div class="board-head">
        <div style="display:flex;align-items:center;gap:10px">
          <span class="index-badge"></span>
          <h2 class="project-name" style="margin:0;font-size:18px"></h2>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <button class="move-up btn" title="Move board up">‚ñ≤</button>
          <button class="move-down btn" title="Move board down">‚ñº</button>
          <button class="collapse-toggle btn" title="Collapse/Expand">‚ñæ</button>
          <button class="add-column btn" title="Add a new column">Ôºã</button>
          <input type="color" class="boardColorPicker" title="Board header color">
          <button class="delete-board btn" title="Erase board">‚ùå</button>
        </div>
      </div>
      <div class="columns"></div>
    </section>
  </template>

  <template id="columnTemplate">
    <div class="column"><div class="col-name" style="font-weight:bold;margin-bottom:4px"></div></div>
  </template>

  <template id="taskTemplate">
    <article class="task" draggable="true">
      <button class="delete-btn" title="Delete task">‚úñ</button>
      <h3 class="t-title"></h3>
      <div class="t-details"></div>
      <div class="t-links"></div>
      <div class="t-attachments"></div>
      <div class="checklist"></div>
      <span class="timer"></span>
      <div class="assignee-badge"></div>
    </article>
  </template>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyCdvzN-WZ-YNKfYCpuNk6nAWzriFbPHLjg",
      authDomain: "kanben-acutesoft.firebaseapp.com",
      projectId: "kanben-acutesoft",
      storageBucket: "kanben-acutesoft.appspot.com",
      messagingSenderId: "637159945341",
      appId: "1:637159945341:web:1c5dbd01eeff6422fd6d14",
      measurementId: "G-GND9Q3PN18"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const kanbanRef = doc(db,"kanban","prod");

    // === Auth ===
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const rightHeader = document.querySelector("header .right");

    const signInBtn = document.createElement("button");
    signInBtn.textContent = "üîë Sign In with Google";
    signInBtn.className = "btn";
    rightHeader.appendChild(signInBtn);

    const signOutBtn = document.createElement("button");
    signOutBtn.textContent = "üö™ Sign Out";
    signOutBtn.className = "btn";
    signOutBtn.style.display = "none";
    rightHeader.appendChild(signOutBtn);

    signInBtn.onclick = async () => { try { await signInWithPopup(auth, provider); } catch(e){ console.error(e); } };
    signOutBtn.onclick = async () => { try { await signOut(auth); } catch(e){ console.error(e); } };

    onAuthStateChanged(auth, user => {
      if(user){
        signInBtn.style.display="none";
        signOutBtn.style.display="inline-block";
        document.getElementById("boards").style.display="flex";
        if(state.logoUrl) document.getElementById("logoPreview").src=state.logoUrl;
        toast("‚úÖ Logged in as " + user.email);
      } else {
        signInBtn.style.display="inline-block";
        signOutBtn.style.display="none";
        document.getElementById("boards").style.display="none";
        toast("‚ùå Signed out");
      }
    });

    // === Toast ===
    const toast = (msg) => {
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      clearTimeout(t._hide); t._hide=setTimeout(()=>t.classList.remove('show'),2000);
    };

    // === State ===
    let state={projects:{},order:[],logoUrl:""};
    const uid=()=>Math.random().toString(36).slice(2,9);

    // === Firestore Sync ===
    async function save(){ await setDoc(kanbanRef,state); }
    onSnapshot(kanbanRef,(snap)=>{ if(snap.exists()){ state=snap.data(); render(); if(state.logoUrl) document.getElementById("logoPreview").src=state.logoUrl; } });

    // === Logo Upload ===
    document.getElementById("uploadLogoBtn").onclick=()=>document.getElementById("logoUpload").click();
    document.getElementById("logoUpload").onchange=async(e)=>{
      const file=e.target.files[0];
      if(!file) return;
      const fileRef=ref(storage,"logo/"+file.name);
      await uploadBytes(fileRef,file);
      state.logoUrl=await getDownloadURL(fileRef);
      save(); render();
    };

    // TODO: Add Drive backup + restore functions here (same as before)

    // === Render Functions ===
    const boards=document.getElementById('boards');
    function render(){
      boards.innerHTML='';
      state.order.forEach((name,i)=>{
        const p=state.projects[name];
        if(p) boards.appendChild(renderBoard(p,i));
      });
      if(state.logoUrl) document.getElementById("logoPreview").src=state.logoUrl;
      save();
    }

    function renderBoard(p,idx){
      const frag=document.getElementById('boardTemplate').content.cloneNode(true);
      const b=frag.querySelector('.board'); b.dataset.project=p.name;
      frag.querySelector('.index-badge').textContent=idx+1;
      frag.querySelector('.project-name').textContent=p.name;
      const cols=frag.querySelector('.columns');
      if(p.collapsed) cols.style.display="none";

      frag.querySelector('.collapse-toggle').onclick=()=>{p.collapsed=!p.collapsed;render();};
      frag.querySelector('.move-up').onclick=()=>{if(idx>0){[state.order[idx-1],state.order[idx]]=[state.order[idx],state.order[idx-1]];render();}};
      frag.querySelector('.move-down').onclick=()=>{if(idx<state.order.length-1){[state.order[idx+1],state.order[idx]]=[state.order[idx],state.order[idx+1]];render();}};
      frag.querySelector('.boardColorPicker').value=p.color||"#ffffff";
      frag.querySelector('.boardColorPicker').oninput=(e)=>{p.color=e.target.value;b.querySelector('.board-head').style.background=p.color;save();};
      frag.querySelector('.delete-board').onclick=()=>{const pw=prompt("Enter GODMODE! password");if(pw==="GODMODE!"){delete state.projects[p.name];state.order=state.order.filter(x=>x!==p.name);render();}};

      p.columns.forEach(c=>{
        const col=document.getElementById('columnTemplate').content.cloneNode(true);
        col.querySelector('.col-name').textContent=c.name;
        const colEl=col.querySelector('.column'); colEl.dataset.colId=c.id;
        colEl.ondragover=(e)=>{e.preventDefault();colEl.classList.add('drag-over');};
        colEl.ondragleave=()=>colEl.classList.remove('drag-over');
        colEl.ondrop=(e)=>{e.preventDefault();colEl.classList.remove('drag-over');const tid=e.dataTransfer.getData("text");const task=Object.values(p.tasks).find(t=>t.id===tid);if(task){task.colId=c.id;save();render();}};
        Object.values(p.tasks).filter(t=>t.colId===c.id).forEach(t=>{colEl.appendChild(renderTask(p,t));});
        cols.appendChild(col);
      });

      frag.querySelector('.add-column').onclick=()=>{const name=prompt("Column name?");if(name){p.columns.push({id:uid(),name});save();render();}};
      return frag;
    }

    function renderTask(p,t){
      const frag=document.getElementById('taskTemplate').content.cloneNode(true);
      const card=frag.querySelector('.task'); card.dataset.id=t.id;
      frag.querySelector('.t-title').textContent=t.title;
      frag.querySelector('.t-details').textContent=t.details||'';

      // Links
      const linksDiv=frag.querySelector('.t-links');
      (t.links||[]).forEach(l=>{
        const a=document.createElement('a');
        a.href=l; a.textContent=l; linksDiv.appendChild(a);
      });

      // Attachments
      const attDiv=frag.querySelector('.t-attachments');
      (t.attachments||[]).forEach(att=>{
        const a=document.createElement('a'); a.href=att.url; a.textContent=att.name; attDiv.appendChild(a);
      });

      // Checklist
      const cl=frag.querySelector('.checklist');
      (t.checklist||[]).forEach(item=>{
        const lbl=document.createElement('label');
        if(item.done) lbl.classList.add('done');
        const cb=document.createElement('input');
        cb.type='checkbox'; cb.checked=!!item.done;
        cb.onchange=()=>{item.done=cb.checked;save();render();};
        lbl.appendChild(cb); lbl.append(item.text); cl.appendChild(lbl);
      });

      // Delete
      frag.querySelector('.delete-btn').onclick=()=>{if(confirm('Delete task?')){delete p.tasks[t.id];save();render();}};

      // Drag + click edit
      card.ondragstart=(e)=>{e.dataTransfer.setData("text",t.id);};
     card.onclick=(e)=>{ if(e.target.classList.contains('delete-btn')) return; openEditDialog(p,t); };

      // Assignee badge
      const badge=frag.querySelector('.assignee-badge');
      if(t.assignee){
        const av=document.createElement('div'); 
        av.className="avatar";
        if(t.avatarUrl) av.style.backgroundImage=`url(${t.avatarUrl})`;
        else av.textContent=t.assignee[0].toUpperCase();
        av.style.background=t.assigneeColor||"#555";
        badge.appendChild(av); 
        badge.append(t.assignee);
      }

      // Timer
      const timer=frag.querySelector('.timer');
      if(!t.created) t.created=Date.now();
      const age=Date.now()-t.created;
      const hours=Math.floor(age/3600000);
      const days=Math.floor(age/86400000);
      timer.textContent=`‚è± ${hours}h`;
      if(age>24*3600000){
        timer.style.color=`rgb(${Math.min(255,150+days*20)},0,0)`;
      }

      return frag;
    }

    // === Task Dialog ===
    const taskDialog=document.getElementById('taskDialog');
    const addTaskBtn=document.getElementById('addTaskBtn');
    addTaskBtn.onclick=()=>{ openEditDialog(); };

    document.getElementById('cancelCreate').onclick=()=>taskDialog.close();

    function openEditDialog(p=null,t=null){
      document.getElementById('editId').value=t?.id||"";
      document.getElementById('editProject').value=p?.name||"";
      document.getElementById('title').value=t?.title||"";
      document.getElementById('project').value=p?.name||"";
      document.getElementById('assignee').value=t?.assignee||"";
      document.getElementById('assigneeColor').value=t?.assigneeColor||"#555555";
      document.getElementById('avatarUrl').value=t?.avatarUrl||"";
      document.getElementById('details').value=t?.details||"";
      taskDialog.showModal();
    }

    taskDialog.querySelector('form').onsubmit=async(e)=>{
      e.preventDefault();
      const id=document.getElementById('editId').value||uid();
      const project=document.getElementById('project').value.trim();
      if(!state.projects[project]){
        state.projects[project]={
          name:project,
          columns:[{id:"todo",name:"To Do"},{id:"doing",name:"Doing"},{id:"done",name:"Done"}],
          tasks:{},color:"#fff"
        };
        state.order.push(project);
      }
      const p=state.projects[project];
      const task={
        id,
        title:document.getElementById('title').value,
        details:document.getElementById('details').value,
        assignee:document.getElementById('assignee').value,
        assigneeColor:document.getElementById('assigneeColor').value,
        avatarUrl:document.getElementById('avatarUrl').value,
        checklist:[],
        links:[],
        attachments:[],
        created:Date.now(),
        colId:p.tasks[id]?.colId||"todo"
      };

      // Handle attachments
      const files=document.getElementById('attachments').files;
      for(let f of files){
        const fileRef=ref(storage,`attachments/${id}/${f.name}`);
        await uploadBytes(fileRef,f);
        const url=await getDownloadURL(fileRef);
        task.attachments.push({name:f.name,url});
      }

      // Handle avatar upload
      const avatarFile=document.getElementById('avatarFile').files[0];
      if(avatarFile){
        const avRef=ref(storage,`avatars/${id}/${avatarFile.name}`);
        await uploadBytes(avRef,avatarFile);
        task.avatarUrl=await getDownloadURL(avRef);
      }

      p.tasks[id]=task;
      save(); render();
      taskDialog.close();
    };

  </script>
</body>
</html>
