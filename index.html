<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Zen Kanban To-Do (Cloud)</title>
  <style>
    :root{--radius:12px}
    *{box-sizing:border-box}
    body{margin:0;font-family:sans-serif;background:#fafafa;color:#111}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #ddd}
    .wrap{max-width:1100px;margin:0 auto;padding:12px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .left,.right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .btn{cursor:pointer;border:1px solid #ccc;background:#fff;padding:6px 10px;border-radius:8px}
    .btn.primary{background:#000;color:#fff;border-color:#000}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .boards{max-width:1100px;margin:20px auto;display:flex;flex-direction:column;gap:16px}
    .board{border:1px solid #ddd;border-radius:var(--radius);background:#fff}
    .board-head{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #ddd}
    .columns{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;padding:12px}
    .column{border:1px dashed #ccc;border-radius:10px;min-height:140px;padding:6px;display:flex;flex-direction:column;gap:6px}
    .column.drag-over{background:#eef6ff;border-color:#2b78ff}
    .task{border:1px solid #ddd;border-radius:10px;padding:8px;background:#fff;cursor:grab;position:relative}
    .task h3{margin:0 0 4px;font-size:14px}
    .delete-btn{position:absolute;top:2px;right:2px;border:none;background:none;color:#a00;font-size:16px;cursor:pointer}
    .t-links a{display:block;font-size:12px;word-break:break-all;color:#0b67c2}
    .t-attachments img{max-width:100px;max-height:80px;border:1px solid #ddd;border-radius:6px}
    .checklist label{display:flex;align-items:center;gap:6px;font-size:12px}
    .checklist label.done{color:#777;text-decoration:line-through}
    .timer{font-size:12px;display:block;margin-top:4px}
    .assignee-badge{display:flex;align-items:center;gap:6px;margin-top:6px}
    .avatar{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;font-weight:bold;background:#555;overflow:hidden;background-size:cover;background-position:center}
    .board.collapsed .columns{display:none}
    dialog{border:none;padding:0;border-radius:16px;box-shadow:0 20px 80px rgba(0,0,0,.18);}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    #taskDialog{width:min(1000px,96vw);max-height:90vh;overflow:auto}
    #taskDialog form{display:flex;flex-direction:column;gap:12px;padding:20px}
    #taskDialog input,#taskDialog textarea{width:100%}
    #taskDialog textarea{min-height:160px}
    #linksContainer,#checklistContainer{padding:10px;border:1px solid #ccc;border-radius:8px}
    .link-input,.check-input{display:flex;gap:6px;margin-top:6px}
    .link-input input,.check-input input{flex:1}
    #taskDialog .actions{display:flex;justify-content:flex-end;gap:10px}
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111;color:#fff;padding:8px 12px;border-radius:8px;font-size:12px;opacity:0;transition:opacity .2s}
    #toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="left">
        <div id="headerLogo"></div>
        <button id="uploadLogoBtn" class="btn">üì∑ Upload Logo</button>
        <input type="file" id="logoUpload" accept="image/*" style="display:none">
        <button id="addTaskBtn" class="btn primary">‚ûï Add Task</button>
      </div>
      <div class="right">
        <button id="backupNow" class="btn" disabled>üíæ Backup</button>
        <button id="restoreBackup" class="btn" disabled>‚ôª Restore</button>
      </div>
    </div>
  </header>

  <main class="boards" id="boards"></main>
  <div id="toast"></div>

  <!-- Task Dialog -->
  <dialog id="taskDialog">
    <form>
      <input type="hidden" id="editId">
      <input type="hidden" id="editProject">
      <label>Title</label><input id="title" required>
      <label>Project</label><input id="project" required>
      <label>Assignee</label><input id="assignee" placeholder="Optional">
      <label>Assignee Colour</label><input type="color" id="assigneeColor" value="#555555">
      <label>Avatar URL</label><input id="avatarUrl" placeholder="https://...">
      <label>Avatar Upload</label><input type="file" id="avatarFile" accept="image/*">
      <label>Details</label><textarea id="details"></textarea>
      <label>Attachments</label><input type="file" id="attachments" multiple>
      <div id="linksContainer">
        <label>Links</label>
        <button type="button" id="addLinkBtn" class="btn">Add Link</button>
      </div>
      <div id="checklistContainer">
        <label>Tasks</label>
        <button type="button" id="addCheckBtn" class="btn">Add Item</button>
      </div>
      <div class="actions">
        <button type="button" id="cancelCreate" class="btn">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Templates -->
  <template id="boardTemplate">
    <section class="board">
      <div class="board-head">
        <div style="display:flex;align-items:center;gap:10px">
          <span class="index-badge"></span>
          <h2 class="project-name" style="margin:0;font-size:18px"></h2>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <button class="move-up btn" title="Move board up">‚ñ≤</button>
          <button class="move-down btn" title="Move board down">‚ñº</button>
          <button class="collapse-toggle btn" title="Collapse/Expand">‚ñæ</button>
          <button class="add-column btn" title="Add column">Ôºã</button>
          <input type="color" class="boardColorPicker" title="Board header color">
          <button class="delete-board btn" title="Erase board">‚ùå</button>
        </div>
      </div>
      <div class="columns"></div>
    </section>
  </template>

  <template id="columnTemplate">
    <div class="column"><div class="col-name" style="font-weight:bold;margin-bottom:4px"></div></div>
  </template>

  <template id="taskTemplate">
    <article class="task" draggable="true">
      <button class="delete-btn" title="Delete task">‚úñ</button>
      <h3 class="t-title"></h3>
      <div class="t-details"></div>
      <div class="t-links"></div>
      <div class="t-attachments"></div>
      <div class="checklist"></div>
      <span class="timer"></span>
      <div class="assignee-badge"></div>
    </article>
  </template>
    <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // === Firebase Config (your live project) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCdvzN-WZ-YNKfYCpuNk6nAWzriFbPHLjg",
      authDomain: "kanben-acutesoft.firebaseapp.com",
      projectId: "kanben-acutesoft",
      storageBucket: "kanben-acutesoft.appspot.com",
      messagingSenderId: "637159945341",
      appId: "1:637159945341:web:1c5dbd01eeff6422fd6d14",
      measurementId: "G-GND9Q3PN18"
    };

    // === Init ===
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Single document store for now
    const kanbanRef = doc(db, "kanban", "prod");

    // === UI Helpers ===
    const toast = (msg) => {
      const t = document.getElementById("toast");
      t.textContent = msg; t.classList.add("show");
      clearTimeout(t._hide); t._hide = setTimeout(()=>t.classList.remove("show"), 2200);
    };

    // === State ===
    let state = { projects:{}, order:[], logoUrl:"" };
    const uid = () => Math.random().toString(36).slice(2,9);

    // === Auth Buttons ===
    const rightHeader = document.querySelector(".right");
    const signInBtn = document.createElement("button");
    signInBtn.className = "btn";
    signInBtn.id = "signInBtn";
    signInBtn.textContent = "üîë Sign In with Google";
    rightHeader.prepend(signInBtn);

    const signOutBtn = document.createElement("button");
    signOutBtn.className = "btn";
    signOutBtn.id = "signOutBtn";
    signOutBtn.textContent = "üö™ Sign Out";
    signOutBtn.style.display = "none";
    rightHeader.prepend(signOutBtn);

    signInBtn.onclick = async () => { try { await signInWithPopup(auth, provider); } catch(e){ console.error(e); toast("Auth error"); } };
    signOutBtn.onclick = async () => { try { await signOut(auth); } catch(e){ console.error(e); toast("Sign-out failed"); } };

    // === Firestore Sync (guarded by auth) ===
    async function save(){
      if(!auth.currentUser){ console.warn("Not signed in; skipping save"); return; }
      try { await setDoc(kanbanRef, state); }
      catch(e){ console.error("Save failed:", e); toast("Save failed"); }
    }

    // Start listening after auth, otherwise we risk permission errors
    let unsub = null;
    onAuthStateChanged(auth, user => {
      if(user){
        signInBtn.style.display = "none";
        signOutBtn.style.display = "inline-block";
        document.getElementById("boards").style.display = "flex";
        toast("‚úÖ Logged in as " + (user.email || "user"));

        if(!unsub){
          unsub = onSnapshot(kanbanRef, (snap)=>{
            if(snap.exists()){
              state = snap.data();
              render();
            } else {
              // Initialize empty default doc
              state = { projects:{}, order:[], logoUrl:"" };
              save();
              render();
            }
          }, (err)=>{ console.error("onSnapshot error", err); toast("Read error"); });
        }
      } else {
        // Signed out
        signInBtn.style.display = "inline-block";
        signOutBtn.style.display = "none";
        document.getElementById("boards").style.display = "none";
        toast("‚ùå Signed out");
        if(unsub){ unsub(); unsub=null; }
      }
    });

    // === Logo upload (hide button after upload; click logo to replace) ===
    const logoContainer = document.getElementById("headerLogo");
    const uploadBtn = document.getElementById("uploadLogoBtn");
    const logoInput = document.getElementById("logoUpload");

    function renderLogo(){
      logoContainer.innerHTML = "";
      if(state.logoUrl){
        const img = document.createElement("img");
        img.src = state.logoUrl;
        img.style.maxHeight = "60px";
        img.style.objectFit = "contain";
        logoContainer.appendChild(img);
        uploadBtn.style.display = "none";
        // Click logo to replace
        logoContainer.onclick = () => logoInput.click();
      } else {
        uploadBtn.style.display = "inline-block";
        logoContainer.onclick = null;
      }
    }

    uploadBtn.onclick = () => logoInput.click();
    logoInput.onchange = async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      try{
        if(!auth.currentUser){ toast("Sign in first"); return; }
        const fileRef = ref(storage, "logo/current");
        await uploadBytes(fileRef, file);
        state.logoUrl = await getDownloadURL(fileRef);
        await save();
        renderLogo();
        toast("‚úÖ Logo updated");
      }catch(err){ console.error(err); toast("Logo upload failed"); }
    };

    // === Google Drive Backup & Restore ===
    const GOOGLE_CLIENT_ID = "21758541847-btkft7unujq2dq56vd43vbpvlscv7ssn.apps.googleusercontent.com";
    let driveAccessToken = null, tokenClient = null;

    // Load Google Identity Services
    const loadGIS = () => new Promise((resolve)=>{
      const s = document.createElement("script");
      s.src = "https://accounts.google.com/gsi/client";
      s.async = true; s.defer = true;
      s.onload = resolve;
      document.head.appendChild(s);
    });
    await loadGIS();

    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: "https://www.googleapis.com/auth/drive.file",
      callback: (t) => {
        driveAccessToken = t.access_token;
        document.getElementById("backupNow").disabled = false;
        document.getElementById("restoreBackup").disabled = false;
        toast("üîó Drive connected");
      }
    });

    // Wire backup buttons
    document.getElementById("backupNow").onclick = async ()=>{
      if(!auth.currentUser){ toast("Sign in first"); return; }
      if(!driveAccessToken){ tokenClient.requestAccessToken(); return; }
      try{
        const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
        const metadata = { name:`kanban-backup-${new Date().toISOString()}.json`, mimeType:"application/json", parents:["root"] };
        const form = new FormData();
        form.append("metadata", new Blob([JSON.stringify(metadata)],{type:"application/json"}));
        form.append("file", blob);
        await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id",{
          method:"POST",
          headers: { "Authorization":"Bearer "+driveAccessToken },
          body: form
        });
        toast("üíæ Backup saved to Drive");
      }catch(e){ console.error(e); toast("Backup failed"); }
    };

    document.getElementById("restoreBackup").onclick = async ()=>{
      if(!auth.currentUser){ toast("Sign in first"); return; }
      if(!driveAccessToken){ tokenClient.requestAccessToken(); return; }
      try{
        const res = await fetch("https://www.googleapis.com/drive/v3/files?q=name contains 'kanban-backup'&orderBy=createdTime desc&fields=files(id,name)&pageSize=1",{
          headers:{ Authorization: "Bearer "+driveAccessToken }
        });
        const data = await res.json();
        const file = data.files?.[0];
        if(!file){ toast("No backups found"); return; }
        const res2 = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`,{
          headers:{ Authorization: "Bearer "+driveAccessToken }
        });
        const restored = await res2.json();
        state = restored;
        await save();
        render();
        toast("‚ôª Restored latest backup");
      }catch(e){ console.error(e); toast("Restore failed"); }
    };

    // Expose these so Part 3 can call them
    window.__app = { db, storage, auth, save, stateRef:()=>state, setState:(s)=>state=s, renderLogo };
        // === Render & UI ===
    const boards = document.getElementById("boards");

    function render(){
      // Logo
      renderLogo();

      // Boards
      boards.innerHTML = "";
      (window.__app.stateRef().order||[]).forEach((name, idx)=>{
        const p = window.__app.stateRef().projects[name];
        if(p) boards.appendChild(renderBoard(p, idx));
      });

      // Persist
      window.__app.save();
    }

    function ensureProject(name){
      const s = window.__app.stateRef();
      if(!s.projects[name]){
        s.projects[name] = {
          name,
          columns: [
            {id:"todo", name:"To Do"},
            {id:"doing", name:"Doing"},
            {id:"done", name:"Done"}
          ],
          tasks:{},
          color:"#ffffff",
          collapsed:false
        };
        s.order.push(name);
      }
      return s.projects[name];
    }

    function renderBoard(p, idx){
      const frag = document.getElementById("boardTemplate").content.cloneNode(true);
      const section = frag.querySelector(".board");
      section.dataset.project = p.name;

      const head = frag.querySelector(".board-head");
      const title = frag.querySelector(".project-name");
      const badge = frag.querySelector(".index-badge");
      badge.textContent = idx+1;
      title.textContent = p.name;

      // header color
      head.style.background = p.color || "#fff";

      // header actions
      frag.querySelector(".boardColorPicker").value = p.color || "#ffffff";
      frag.querySelector(".boardColorPicker").oninput = (e)=>{ p.color=e.target.value; window.__app.save(); render(); };

      frag.querySelector(".collapse-toggle").onclick = ()=>{
        p.collapsed = !p.collapsed;
        window.__app.save(); render();
      };

      frag.querySelector(".move-up").onclick = ()=>{
        const s=window.__app.stateRef();
        if(idx>0){ [s.order[idx-1], s.order[idx]] = [s.order[idx], s.order[idx-1]]; window.__app.save(); render(); }
      };

      frag.querySelector(".move-down").onclick = ()=>{
        const s=window.__app.stateRef();
        if(idx<s.order.length-1){ [s.order[idx+1], s.order[idx]] = [s.order[idx], s.order[idx+1]]; window.__app.save(); render(); }
      };

      frag.querySelector(".delete-board").onclick = ()=>{
        const pw = prompt("Enter GODMODE! password");
        if(pw==="GODMODE!"){
          const s = window.__app.stateRef();
          delete s.projects[p.name];
          s.order = s.order.filter(n=>n!==p.name);
          window.__app.save(); render();
        }
      };

      frag.querySelector(".add-column").onclick = ()=>{
        const name = prompt("Column name?");
        if(name){
          p.columns.push({id:uid(),name});
          window.__app.save(); render();
        }
      };

      // columns + tasks
      const cols = frag.querySelector(".columns");
      if(p.collapsed){ cols.style.display="none"; }

      p.columns.forEach(c=>{
        const cfrag = document.getElementById("columnTemplate").content.cloneNode(true);
        const col = cfrag.querySelector(".column");
        cfrag.querySelector(".col-name").textContent = c.name;
        col.dataset.colId = c.id;

        // drag-over
        col.ondragover = (e)=>{ e.preventDefault(); col.classList.add("drag-over"); };
        col.ondragleave = ()=>{ col.classList.remove("drag-over"); };

        // drop -> move task within this board
        col.ondrop = (e)=>{
          e.preventDefault(); col.classList.remove("drag-over");
          const tid = e.dataTransfer.getData("text");
          const task = Object.values(p.tasks).find(t=>t.id===tid);
          if(task){
            task.colId = c.id;
            window.__app.save(); render();
          }
        };

        // render tasks in this column
        Object.values(p.tasks).filter(t=>t.colId===c.id).forEach(t=>{
          col.appendChild(renderTask(p,t));
        });

        cols.appendChild(cfrag);
      });

      return frag;
    }

    function renderTask(p,t){
      const frag = document.getElementById("taskTemplate").content.cloneNode(true);
      const card = frag.querySelector(".task"); 
      card.dataset.id = t.id;

      frag.querySelector(".t-title").textContent = t.title;
      frag.querySelector(".t-details").textContent = t.details || "";

      // Links
      const linksEl = frag.querySelector(".t-links");
      (t.links||[]).forEach(l=>{
        const url = (l?.url||"").trim();
        if(url){
          const a=document.createElement("a");
          a.href = /^https?:\/\//i.test(url) ? url : ("https://"+url);
          a.textContent = l.label || url;
          a.target="_blank";
          linksEl.appendChild(a);
        }
      });

      // Attachments
      const attEl = frag.querySelector(".t-attachments");
      (t.attachments||[]).forEach(a=>{
        if(!a?.url) return;
        if((a.type||"").startsWith("image/")){
          const img=document.createElement("img");
          img.src=a.url; img.alt=a.name||"image";
          attEl.appendChild(img);
        } else {
          const link=document.createElement("a");
          link.href=a.url; link.target="_blank";
          link.textContent=a.name||"file";
          attEl.appendChild(link);
        }
      });

      // Checklist
      const cl = frag.querySelector(".checklist");
      (t.checklist||[]).forEach((item,idx)=>{
        const label=document.createElement("label");
        const cb=document.createElement("input");
        cb.type="checkbox"; cb.checked=!!item.done;
        cb.onchange=()=>{ item.done=cb.checked; window.__app.save(); render(); };
        label.appendChild(cb);
        label.append(document.createTextNode(item.text||""));
        if(item.done) label.classList.add("done");
        cl.appendChild(label);
      });

      // Timer
      const h = frag.querySelector(".timer");
      if(!t.created) t.created=Date.now();
      const age = Date.now()-t.created;
      const hours = Math.floor(age/3600000);
      const days = Math.floor(age/86400000);
      h.textContent = `‚è± ${hours}h`;
      if(age > 24*3600000){
        // turn red & intensify by day
        h.style.color = `rgb(${Math.min(255, 150 + days*20)}, 0, 0)`;
        h.style.fontWeight = "bold";
      }

      // Assignee badge
      const ab = frag.querySelector(".assignee-badge");
      if(t.assignee){
        const av=document.createElement("div");
        av.className = "avatar";
        if(t.avatarUrl){ av.style.backgroundImage = `url(${t.avatarUrl})`; }
        else { av.textContent = t.assignee.charAt(0).toUpperCase(); }
        av.style.background = t.assigneeColor || "#555";
        ab.appendChild(av);
        const name=document.createElement("span");
        name.textContent = t.assignee;
        ab.appendChild(name);
      }

      // Delete
      frag.querySelector(".delete-btn").onclick = ()=>{
        delete p.tasks[t.id];
        window.__app.save(); render();
      };

      // Drag + click edit
      card.ondragstart = (e)=>{ e.dataTransfer.setData("text", t.id); };
      card.onclick = (e)=>{ if(e.target.classList.contains("delete-btn")) return; openDialog(p, t); };

      return frag;
    }

    // === Dialog ===
    const dlg = document.getElementById("taskDialog");
    const form = dlg.querySelector("form");
    document.getElementById("addTaskBtn").onclick = ()=> openDialog();

    document.getElementById("cancelCreate").onclick = ()=> dlg.close();

    // Link & Checklist helpers
    function addLinkInput(url="", label=""){
      const wrap = document.createElement("div");
      wrap.className = "link-input";
      wrap.innerHTML = `
        <input class="url" placeholder="url (optional)" value="${url}">
        <input class="label" placeholder="label (optional)" value="${label}">
        <button type="button" class="btn remove">‚úñ</button>
      `;
      wrap.querySelector(".remove").onclick = ()=> wrap.remove();
      document.getElementById("linksContainer").appendChild(wrap);
    }
    document.getElementById("addLinkBtn").onclick = ()=> addLinkInput();

    function addCheckInput(text="", done=false){
      const wrap = document.createElement("div");
      wrap.className = "check-input";
      wrap.innerHTML = `
        <input class="text" placeholder="task" value="${text}">
        <input type="checkbox" class="done" ${done?"checked":""}>
        <button type="button" class="btn remove">‚úñ</button>
      `;
      wrap.querySelector(".remove").onclick = ()=> wrap.remove();
      document.getElementById("checklistContainer").appendChild(wrap);
    }
    document.getElementById("addCheckBtn").onclick = ()=> addCheckInput();

    function openDialog(project=null, task=null){
      form.reset();
      // clear dynamic lists
      document.querySelectorAll("#linksContainer .link-input").forEach(n=>n.remove());
      document.querySelectorAll("#checklistContainer .check-input").forEach(n=>n.remove());
      document.getElementById("attachments").value = null;
      document.getElementById("avatarFile").value = null;

      document.getElementById("editId").value = task?.id || "";
      document.getElementById("editProject").value = project?.name || "";

      document.getElementById("title").value = task?.title || "";
      document.getElementById("project").value = project?.name || "";
      document.getElementById("assignee").value = task?.assignee || "";
      document.getElementById("assigneeColor").value = task?.assigneeColor || "#555555";
      document.getElementById("avatarUrl").value = task?.avatarUrl || "";
      document.getElementById("details").value = task?.details || "";

      (task?.links||[]).forEach(l=> addLinkInput(l.url||"", l.label||""));
      (task?.checklist||[]).forEach(i=> addCheckInput(i.text||"", !!i.done));
      if(!task){ addCheckInput(""); }

      dlg.showModal();
    }

    form.onsubmit = async (e)=>{
      e.preventDefault();
      if(!window.__app.auth.currentUser){ toast("Sign in first"); return; }

      const id = document.getElementById("editId").value || uid();
      const projName = (document.getElementById("project").value || "").trim();
      if(!projName){ toast("Project required"); return; }

      const s = window.__app.stateRef();
      const proj = ensureProject(projName);
      const prev = proj.tasks[id] || { id, created: Date.now(), colId: "todo" };

      const task = {
        ...prev,
        title: document.getElementById("title").value,
        details: document.getElementById("details").value,
        assignee: document.getElementById("assignee").value,
        assigneeColor: document.getElementById("assigneeColor").value,
        avatarUrl: document.getElementById("avatarUrl").value,
        links: [...document.querySelectorAll("#linksContainer .link-input")].map(div=>({
          url: div.querySelector(".url").value.trim(),
          label: div.querySelector(".label").value.trim()
        })).filter(x=>x.url || x.label),
        checklist: [...document.querySelectorAll("#checklistContainer .check-input")].map(div=>({
          text: div.querySelector(".text").value.trim(),
          done: div.querySelector(".done").checked
        })).filter(x=>x.text),
        attachments: prev.attachments || []
      };

      // Upload avatar file if chosen
      const avatarFile = document.getElementById("avatarFile").files[0];
      if(avatarFile){
        const avRef = ref(window.__app.storage, `avatars/${id}/${avatarFile.name}`);
        await uploadBytes(avRef, avatarFile);
        task.avatarUrl = await getDownloadURL(avRef);
      }

      // Upload attachments
      const files = document.getElementById("attachments").files;
      for(const f of files){
        const aRef = ref(window.__app.storage, `attachments/${id}/${f.name}`);
        await uploadBytes(aRef, f);
        const url = await getDownloadURL(aRef);
        task.attachments.push({ name:f.name, url, type:f.type||"" });
      }

      proj.tasks[id] = task;
      await window.__app.save();
      render();
      dlg.close();
      toast("‚úÖ Task saved");
    };

    // Initial UI bootstrap (renders logo if present; boards come via onSnapshot after login)
    renderLogo();
  </script>
</body>
</html>
