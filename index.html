
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Zen Kanban To-Do (Cloud)</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#fafafa}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #ddd}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;display:flex;justify-content:space-between;align-items:center}
    .btn{cursor:pointer;border:1px solid #ccc;background:#fff;padding:6px 12px;border-radius:6px}
    .btn.primary{background:#000;color:#fff}
    .boards{max-width:1100px;margin:24px auto;display:flex;flex-direction:column;gap:16px}
    .board{border:1px solid #ddd;border-radius:12px;background:#fff}
    .board-head{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #ddd;cursor:grab}
    .columns{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:12px}
    .column{border:1px dashed #ccc;border-radius:8px;min-height:120px;padding:6px;display:flex;flex-direction:column;gap:6px}
    .column.drag-over{background:#f0f8ff;border-color:#0077ff}
    .task{border:1px solid #ddd;border-radius:8px;padding:8px;background:#fff;cursor:grab;position:relative}
    .task h3{margin:0 0 4px;font-size:14px}
    .delete-btn{position:absolute;top:2px;right:2px;cursor:pointer;border:none;background:none;color:#900}
    .compact .t-details,.compact .t-links,.compact .t-attachments,.compact .checklist{display:none}
    .t-links a{display:block;font-size:12px;color:#0077cc;word-break:break-all}
    .t-attachments img{max-width:90px;max-height:70px;border-radius:4px;border:1px solid #ccc}
    .t-attachments a{display:inline-block;font-size:12px}
    .checklist label{display:flex;align-items:center;font-size:12px;gap:6px}
    .checklist label.done{color:#888;text-decoration:line-through;opacity:0.7}
    .timer{font-size:12px;display:block;margin-top:4px}
    .assignee-badge{display:flex;align-items:center;gap:6px;margin-top:6px}
    .avatar{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;font-weight:bold;background:#555;overflow:hidden;background-size:cover;background-position:center}
    dialog{border:none;padding:0;border-radius:12px;box-shadow:0 20px 80px rgba(0,0,0,.18);}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    #taskDialog{width:min(900px,96vw);max-height:90vh;overflow:auto}
    #taskDialog form{display:flex;flex-direction:column;gap:12px;padding:20px}
    #taskDialog input,#taskDialog textarea{width:100%;box-sizing:border-box}
    #taskDialog textarea{min-height:120px}
    #linksContainer,#checklistContainer{padding:10px;border:1px solid #ccc;border-radius:6px}
    .link-input,.check-input{display:flex;gap:6px;margin-top:6px}
    .link-input input,.check-input input{flex:1}
    #taskDialog .actions{display:flex;justify-content:flex-end;gap:10px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div>Zen Kanban (Cloud)</div>
    <button id="addTaskBtn" class="btn primary">‚ûï Add Task</button>
  </div>
</header>

<main class="boards" id="boards"></main>

<dialog id="taskDialog">
  <form>
    <input type="hidden" id="editId">
    <label>Title</label><input id="title" required>
    <label>Project</label><input id="project" required>
    <label>Assignee</label><input id="assignee" placeholder="Optional">
    <label>Assignee Colour</label><input type="color" id="assigneeColor" value="#555555">
    <label>Avatar URL</label><input id="avatarUrl" placeholder="https://...">
    <label>Avatar Upload</label><input type="file" id="avatarFile" accept="image/*">
    <label>Details</label><textarea id="details"></textarea>
    <label>Attachments</label><input type="file" id="attachments" multiple>
    <div id="linksContainer">
      <label>Links</label>
      <button type="button" id="addLinkBtn" class="btn">Add Link</button>
    </div>
    <div id="checklistContainer">
      <label>Tasks</label>
      <button type="button" id="addCheckBtn" class="btn">Add Item</button>
    </div>
    <div class="actions">
      <button type="button" id="cancelCreate" class="btn">Cancel</button>
      <button type="submit" class="btn primary">Save</button>
    </div>
  </form>
</dialog>

<template id="boardTemplate">
  <section class="board" draggable="true">
    <div class="board-head">
      <div style="display:flex;align-items:center;gap:10px">
        <span class="index-badge"></span>
        <h2 class="project-name" style="margin:0;font-size:18px"></h2>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button class="toggle-view btn">üóñ Expanded</button>
        <input type="color" class="boardColorPicker">
        <button class="delete-board btn">‚ùå</button>
      </div>
    </div>
    <div class="columns"></div>
  </section>
</template>

<template id="columnTemplate">
  <div class="column"><div class="col-name" style="font-weight:bold;margin-bottom:4px"></div></div>
</template>

<template id="taskTemplate">
  <article class="task" draggable="true">
    <button class="delete-btn">‚úñ</button>
    <h3 class="t-title"></h3>
    <div class="t-details"></div>
    <div class="t-links"></div>
    <div class="t-attachments"></div>
    <div class="checklist"></div>
    <span class="timer"></span>
    <div class="assignee-badge"></div>
  </article>
</template>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // üîë Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCdvzN-WZ-YNKfYCpuNk6nAWzriFbPHLjg",
    authDomain: "kanben-acutesoft.firebaseapp.com",
    projectId: "kanben-acutesoft",
    storageBucket: "kanben-acutesoft.firebasestorage.app",
    messagingSenderId: "637159945341",
    appId: "1:637159945341:web:1c5dbd01eeff6422fd6d14",
    measurementId: "G-GND9Q3PN18"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const docRef = doc(db, "kanban", "shared");

  let state={projects:{},order:[]};
  const uid=()=>Math.random().toString(36).slice(2,9);
  const save=()=>setDoc(docRef,state);

  // üîÑ Firestore listener
  onSnapshot(docRef,snap=>{
    if(snap.exists()){state=snap.data(); render();}
  });

  // ================= RENDER =================
  const boards=document.getElementById('boards');
  const render=()=>{
    boards.innerHTML='';
    state.order.forEach((name,idx)=>{
      const p=state.projects[name]; if(!p) return;
      const frag=document.getElementById('boardTemplate').content.cloneNode(true);
      const b=frag.querySelector('.board'); b.dataset.project=p.name;
      frag.querySelector('.index-badge').textContent=idx+1;
      frag.querySelector('.project-name').textContent=p.name;
      frag.querySelector('.toggle-view').textContent=p.compact?"üóï Compact":"üóñ Expanded";
      frag.querySelector('.toggle-view').addEventListener('click',()=>{p.compact=!p.compact; save();});
      frag.querySelector('.delete-board').addEventListener('click',()=>{
        if(prompt("Enter GODMODE! password")!=="GODMODE!") return alert("Wrong password!");
        delete state.projects[p.name]; state.order=state.order.filter(n=>n!==p.name); save();
      });
      const picker=frag.querySelector('.boardColorPicker'); picker.value=p.color||'#eee';
      picker.addEventListener('input',()=>{p.color=picker.value; save();});
      b.querySelector('.board-head').style.background=p.color||'#eee';

      // Board drag
      b.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/board',p.name);});
      b.addEventListener('dragover',e=>{if(e.dataTransfer.types.includes('text/board')) e.preventDefault();});
      b.addEventListener('drop',e=>{
        const dragged=e.dataTransfer.getData('text/board');
        if(dragged && dragged!==p.name){
          const arr=state.order; const from=arr.indexOf(dragged), to=arr.indexOf(p.name);
          arr.splice(to,0,arr.splice(from,1)[0]); save();
        }
      });

      // columns
      const cols=frag.querySelector('.columns');
      p.columns.forEach(c=>{
        const col=document.getElementById('columnTemplate').content.cloneNode(true);
        const colDiv=col.querySelector('.column'); colDiv.dataset.colId=c.id; colDiv.querySelector('.col-name').textContent=c.name;
        colDiv.addEventListener('dragover',e=>{if(e.dataTransfer.types.includes('text/task')){e.preventDefault(); colDiv.classList.add('drag-over');}});
        colDiv.addEventListener('dragleave',()=>colDiv.classList.remove('drag-over'));
        colDiv.addEventListener('drop',e=>{
          if(!e.dataTransfer.types.includes('text/task')) return;
          e.preventDefault(); colDiv.classList.remove('drag-over');
          const tid=e.dataTransfer.getData('text/task'); const srcProj=e.dataTransfer.getData('text/project');
          if(!state.projects[srcProj]?.tasks[tid]) return;
          if(c.name==="Completed" && prompt("Enter GODMODE! password")!=="GODMODE!") return alert("Wrong password!");
          const task=state.projects[srcProj].tasks[tid];
          delete state.projects[srcProj].tasks[tid];
          p.tasks[tid]=task; task.colId=c.id; save();
        });
        cols.appendChild(col);
      });
      Object.values(p.tasks).forEach(t=>{
        const col=cols.querySelector(`[data-col-id="${t.colId||p.columns[0].id}"]`);
        (col||cols.firstChild).appendChild(renderTask(p,t));
      });
      boards.appendChild(frag);
    });
  };

  const renderTask=(p,t)=>{
    const frag=document.getElementById('taskTemplate').content.cloneNode(true);
    const card=frag.querySelector('.task'); card.dataset.id=t.id; if(p.compact) card.classList.add('compact');
    card.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/task',t.id); e.dataTransfer.setData('text/project',p.name);});
    frag.querySelector('.delete-btn').addEventListener('click',()=>{if(confirm('Delete task?')){delete p.tasks[t.id]; save();}});
    frag.querySelector('.t-title').textContent=t.title;
    frag.querySelector('.t-details').textContent=t.details||'';

    const linksDiv=frag.querySelector('.t-links');
    (t.links||[]).forEach(l=>{let a=document.createElement('a'); a.href=/^https?:\/\//i.test(l)?l:"https://"+l; a.textContent=l; a.target='_blank'; linksDiv.appendChild(a);});

    const attDiv=frag.querySelector('.t-attachments');
    (t.attachments||[]).forEach(att=>{if(att.type&&att.type.startsWith('image/')){let img=document.createElement('img'); img.src=att.url; attDiv.appendChild(img);} else {let a=document.createElement('a'); a.href=att.url; a.target='_blank'; a.textContent=att.name||'Attachment'; attDiv.appendChild(a);}});

    const cl=frag.querySelector('.checklist');
    (t.checklist||[]).forEach(item=>{const lbl=document.createElement('label'); if(item.done) lbl.classList.add('done'); const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!item.done; cb.addEventListener('change',()=>{item.done=cb.checked; lbl.classList.toggle('done',cb.checked); save();}); lbl.appendChild(cb); lbl.appendChild(document.createTextNode(item.text)); cl.appendChild(lbl);});

    const timerEl=frag.querySelector('.timer');
    const tick=()=>{const start=t.createdAt||Date.now(); const elapsed=Date.now()-start; const s=Math.floor(elapsed/1000)%60,m=Math.floor(elapsed/60000)%60,h=Math.floor(elapsed/3600000); timerEl.textContent=`${h}h ${m}m ${s}s`; if(elapsed>86400000){const days=Math.floor(elapsed/86400000); const red=Math.min(255,150+days*30); timerEl.style.color=`rgb(${red},0,0)`;}}; tick(); setInterval(tick,1000);

    const badge=frag.querySelector('.assignee-badge');
    if(t.assignee){const avatar=document.createElement('div'); avatar.className='avatar'; if(t.avatarUrl){avatar.style.backgroundImage=`url(${t.avatarUrl})`;} else {avatar.style.background=t.assigneeColor||'#555'; avatar.textContent=(t.assignee[0]||'?').toUpperCase();} badge.appendChild(avatar); badge.appendChild(document.createTextNode(t.assignee));}

    card.addEventListener('click',e=>{if(!e.target.classList.contains('delete-btn')) openEditDialog(p,t);});
    return frag;
  };

  // ================= DIALOG =================
  const dialog=document.getElementById('taskDialog'); const form=dialog.querySelector('form');
  document.getElementById('addTaskBtn').addEventListener('click',()=>openEditDialog());
  document.getElementById('cancelCreate').addEventListener('click',()=>dialog.close());
  dialog.addEventListener('click',e=>{if(e.target.id==='addLinkBtn') addLinkInput(''); if(e.target.id==='addCheckBtn') addCheckInput('');});

  const addLinkInput=(value)=>{const container=document.getElementById('linksContainer'); const div=document.createElement('div'); div.className='link-input'; const input=document.createElement('input'); input.type='text'; input.placeholder='website.com'; input.value=value||''; const btn=document.createElement('button'); btn.type='button'; btn.textContent='‚úñ'; btn.addEventListener('click',()=>div.remove()); div.appendChild(input); div.appendChild(btn); container.appendChild(div);};
  const addCheckInput=(value)=>{const container=document.getElementById('checklistContainer'); const div=document.createElement('div'); div.className='check-input'; const input=document.createElement('input'); input.type='text'; input.placeholder='Task item'; input.value=value||''; const btn=document.createElement('button'); btn.type='button'; btn.textContent='‚úñ'; btn.addEventListener('click',()=>div.remove()); div.appendChild(input); div.appendChild(btn); container.appendChild(div);};

  const openEditDialog=(project,t)=>{form.reset(); document.getElementById('linksContainer').innerHTML='<label>Links</label><button type="button" id="addLinkBtn" class="btn">Add Link</button>'; document.getElementById('checklistContainer').innerHTML='<label>Tasks</label><button type="button" id="addCheckBtn" class="btn">Add Item</button>'; document.getElementById('attachments').value=null; document.getElementById('avatarFile').value=null; if(t){document.getElementById('editId').value=t.id; document.getElementById('title').value=t.title; document.getElementById('project').value=project.name; document.getElementById('assignee').value=t.assignee||''; document.getElementById('assigneeColor').value=t.assigneeColor||'#555555'; document.getElementById('avatarUrl').value=t.avatarUrl||''; (t.links||[]).forEach(l=>addLinkInput(l)); (t.checklist||[]).forEach(item=>addCheckInput(item.text)); document.getElementById('details').value=t.details||'';} else {document.getElementById('editId').value='';} dialog.showModal();};

  form.add
  form.addEventListener('submit',async e=>{
    e.preventDefault();
    const id=document.getElementById('editId').value;
    const title=document.getElementById('title').value.trim();
    const projectName=document.getElementById('project').value.trim();
    if(!title||!projectName) return;

    const assignee=document.getElementById('assignee').value.trim();
    const assigneeColor=document.getElementById('assigneeColor').value;
    const avatarUrl=document.getElementById('avatarUrl').value.trim();
    const links=[...document.querySelectorAll('#linksContainer input[type="text"]')].map(i=>i.value).filter(Boolean);
    const details=document.getElementById('details').value.trim();
    const checklist=[...document.querySelectorAll('#checklistContainer .check-input input')].map(i=>({text:i.value,done:false})).filter(i=>i.text);
    const files=[...document.getElementById('attachments').files].map(f=>({name:f.name,type:f.type,url:URL.createObjectURL(f)}));

    let proj=state.projects[projectName];
    if(!proj){
      proj={name:projectName,columns:[{id:uid(),name:'To Do'},{id:uid(),name:'In Progress'},{id:uid(),name:'Completed'}],tasks:{},color:'#eee'};
      state.projects[projectName]=proj; state.order.push(projectName);
    }

    if(id && proj.tasks[id]){
      Object.assign(proj.tasks[id],{title,details,assignee,assigneeColor,avatarUrl,links,attachments:files,checklist});
    } else {
      const newId=uid();
      proj.tasks[newId]={id:newId,title,details,assignee,assigneeColor,avatarUrl,links,attachments:files,checklist,createdAt:Date.now()};
    }
    await save();
    dialog.close();
  });

  // Bootstrap sample project if empty
  onSnapshot(docRef,snap=>{
    if(!snap.exists()){
      const sample={name:'Sample Project',columns:[{id:uid(),name:'To Do'},{id:uid(),name:'In Progress'},{id:uid(),name:'Completed'}],tasks:{},color:'#eee'};
      const tid=uid();
      sample.tasks[tid]={id:tid,title:'Example task',details:'Click to edit me',assignee:'You',assigneeColor:'#555',links:['example.com'],attachments:[],checklist:[{text:'Sample item',done:false}],createdAt:Date.now()};
      state.projects[sample.name]=sample; state.order.push(sample.name);
      save();
    }
  });

</script>
</body>
</html>
